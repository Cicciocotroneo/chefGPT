<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bimby TM6 - Smart Converter</title>
    <style>
        :root { 
            --bimby-green: #3f5e55; 
            --bg-color: #f0f4f3; 
            --error-red: #ffecec;
            --success-green: #e8f5e9;
        }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); padding: 20px; color: #333; max-width: 800px; margin: 0 auto; }
        
        /* CONTENITORI */
        .container { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
        h1 { color: var(--bimby-green); text-align: center; margin-top: 0; }
        .section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid #eee; }
        
        /* INPUT E ELEMENTI UI */
        label { font-weight: bold; display: block; margin-bottom: 8px; color: #555; }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        
        /* BOTTONI */
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: bold; margin-top: 12px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .btn-primary { background: var(--bimby-green); color: white; box-shadow: 0 4px 10px rgba(63, 94, 85, 0.3); }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .btn-check { background: #4b90ff; color: white; }
        .btn-print { background: #333; color: white; margin-top: 30px; }
        
        .btn-help { background: #eef5f3; color: var(--bimby-green); border: 1px solid #dce4e2; width: auto; padding: 5px 10px; font-size: 0.8em; margin: 0; display: inline-block; vertical-align: middle; margin-left: 10px; }
        .btn-help:hover { background: #e0e8e6; }

        .btn-remove { background: transparent; color: #999; border: 1px solid #ddd; padding: 8px; font-size: 12px; margin-top: 5px; width: auto; display: inline-flex; }
        .btn-remove:hover { background: #ffeeee; color: red; border-color: red; }

        /* MODALE POPUP ISTRUZIONI */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px; }
        .close-modal:hover { color: #000; }
        .step-list { padding-left: 20px; line-height: 1.6; }
        .step-list li { margin-bottom: 10px; }

        /* STATUS BOX */
        .status-box { padding: 12px; border-radius: 6px; font-size: 0.9em; margin-top: 10px; display: none; }
        .status-error { background: var(--error-red); color: #d32f2f; border: 1px solid #ffcdd2; }
        .status-success { background: var(--success-green); color: #2e7d32; border: 1px solid #c8e6c9; }

        /* SCHEDA RICETTA */
        #recipeCard { display: none; margin-top: 40px; border: 1px solid #e0e0e0; padding: 30px; border-radius: 12px; background: #fff; position: relative; }
        #recipeCard::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 5px; background: var(--bimby-green); border-radius: 12px 12px 0 0; }
        
        .recipe-header { border-bottom: 1px dashed #ccc; margin-bottom: 25px; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 10px; }
        .recipe-title { font-size: 1.8em; color: var(--bimby-green); margin: 0; font-weight: 800; }
        .recipe-meta { font-size: 0.9em; color: #555; font-weight: bold; background: #f4f4f4; padding: 6px 12px; border-radius: 20px; }

        .step { margin-bottom: 20px; page-break-inside: avoid; }
        .step-num { font-weight: bold; color: var(--bimby-green); text-transform: uppercase; font-size: 0.75em; letter-spacing: 1px; display: block; margin-bottom: 4px; }
        .step-desc { font-size: 1.1em; line-height: 1.6; color: #222; }
        .tm6-tag { display: inline-block; background: #eef5f3; padding: 5px 10px; border-radius: 6px; font-size: 0.9em; font-weight: bold; margin-top: 8px; color: #2c423b; border: 1px solid #dce4e2; }
        
        /* STAMPA (PDF) */
        @media print {
            body { background: white; padding: 0; margin: 0; color: black; }
            .container { box-shadow: none; padding: 0; border: none; width: 100%; max-width: 100%; }
            .no-print, .section, h1, button, .status-box, .modal { display: none !important; }
            #recipeCard { display: block !important; border: none; padding: 0; margin: 0; box-shadow: none; }
            .step { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
            .tm6-tag { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
            #printFooter { display: block !important; margin-top: 30px; font-size: 0.8em; color: #999; text-align: center; }
        }
        #printFooter { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="no-print">üç≥ Bimbify</h1>

        <div class="section no-print">
            <label>
                1. Google API Key 
                <button class="btn-help" onclick="toggleModal(true)">‚ùì Guida: Come crearla?</button>
                <span id="savedBadge" style="display:none; color:green; font-size:0.8em; margin-left:10px;">(Salvata ‚úÖ)</span>
            </label>
            
            <div style="display:flex; gap:10px;">
                <input type="password" id="apiKey" placeholder="Incolla qui la tua chiave (AIza...)" />
            </div>
            
            <button class="btn-check" onclick="findWorkingModel()">üîÑ Connetti e Salva</button>
            <button class="btn-remove" onclick="removeKey()" id="removeBtn" style="display:none;">üóëÔ∏è Dimentica chiave</button>
            
            <div id="configStatus" class="status-box"></div>
            
            <div id="modelSelectionArea" style="display:none; margin-top:15px; background:#f9f9f9; padding:10px; border-radius:8px;">
                <label style="margin-bottom:0; font-size:0.9em;">Modello AI attivo:</label>
                <select id="modelSelect" style="width:100%; padding:8px; margin-top:5px; border:1px solid #ddd; border-radius:4px;"></select>
            </div>
        </div>

        <div class="section no-print">
            <label>2. Incolla la Ricetta</label>
            <textarea id="recipeInput" style="height:120px" placeholder="Esempio: 300g di farina, 2 uova... impastare tutto..."></textarea>
            
            <button id="convertBtn" class="btn-primary" onclick="processRecipe()" disabled>
                üîí Configura API Key per iniziare
            </button>
        </div>

        <div id="recipeCard">
            <div class="recipe-header">
                <h2 id="resTitle" class="recipe-title">Nome Ricetta</h2>
                <span id="resServings" class="recipe-meta">Dosi per X persone</span>
            </div>
            <div id="stepsContainer"></div>
            <div id="printFooter">Generato con Bimby AI Converter</div>
        </div>

        <button id="printBtn" class="btn-print no-print" style="display:none;" onclick="window.print()">
            üñ®Ô∏è Stampa / Salva PDF
        </button>
    </div>

    <div id="helpModal" class="modal" onclick="closeModalOnClick(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="toggleModal(false)">&times;</span>
            <h2 style="margin-top:0; color:var(--bimby-green)">Come ottenere la API Key</h2>
            <p>La chiave √® gratuita e serve per far funzionare l'Intelligenza Artificiale.</p>
            <ol class="step-list">
                <li>Vai sul sito <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#4b90ff; font-weight:bold;">Google AI Studio</a>.</li>
                <li>Accedi con il tuo account Google (Gmail).</li>
                <li>Clicca sul pulsante blu <b>"Create API Key"</b>.</li>
                <li>Seleziona "Create API key in new project".</li>
                <li>Copia il codice che inizia con <code>AIza...</code> e incollalo qui.</li>
            </ol>
            <p style="font-size:0.9em; background:#fff3cd; padding:10px; border-radius:5px;">
                ‚ö†Ô∏è <b>Nota:</b> La chiave viene salvata solo nel tuo browser. Nessun altro pu√≤ vederla.
            </p>
            <button class="btn-primary" onclick="toggleModal(false)" style="margin-top:20px;">Ho capito, chiudi</button>
        </div>
    </div>

    <script>
        // --- GESTIONE MODALE ---
        function toggleModal(show) {
            document.getElementById('helpModal').style.display = show ? 'block' : 'none';
        }
        
        function closeModalOnClick(event) {
            if (event.target == document.getElementById('helpModal')) {
                toggleModal(false);
            }
        }

        // --- GESTIONE LOCAL STORAGE ---
        const STORAGE_KEY = 'bimby_converter_apikey';

        window.onload = function() {
            const savedKey = localStorage.getItem(STORAGE_KEY);
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                document.getElementById('savedBadge').style.display = 'inline';
                document.getElementById('removeBtn').style.display = 'inline-flex';
                findWorkingModel(true); 
            }
        };

        function removeKey() {
            if(confirm("Vuoi rimuovere la chiave salvata da questo browser?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- LOGICA API ---
        async function findWorkingModel(isAutoLogin = false) {
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusBox = document.getElementById('configStatus');
            const selectBox = document.getElementById('modelSelect');
            const convertBtn = document.getElementById('convertBtn');

            if(apiKey.length < 5) return !isAutoLogin && alert("Chiave mancante o troppo corta.");

            statusBox.className = 'status-box'; 
            statusBox.style.display = 'block';
            statusBox.innerText = isAutoLogin ? "Connessione automatica..." : "Verifica chiave e salvataggio...";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error.message);
                if (!data.models) throw new Error("Nessun modello trovato.");

                const compatibleModels = data.models.filter(m => 
                    m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent")
                );

                if (compatibleModels.length === 0) throw new Error("La chiave √® valida ma non ha accesso ai modelli di testo.");

                compatibleModels.sort((a, b) => {
                    const priority = name => {
                        if (name.includes('flash')) return 3;
                        if (name.includes('1.5-pro')) return 2;
                        return 1;
                    };
                    return priority(b.name) - priority(a.name);
                });

                selectBox.innerHTML = "";
                compatibleModels.forEach(m => {
                    const cleanName = m.name.replace('models/', '');
                    const option = document.createElement('option');
                    option.value = cleanName; 
                    option.text = m.displayName ? `${m.displayName} (${cleanName})` : cleanName;
                    selectBox.appendChild(option);
                });

                localStorage.setItem(STORAGE_KEY, apiKey);
                document.getElementById('savedBadge').style.display = 'inline';
                document.getElementById('removeBtn').style.display = 'inline-flex';

                statusBox.className = 'status-box status-success';
                statusBox.innerText = `‚úÖ Connesso! Modello: ${compatibleModels[0].displayName || compatibleModels[0].name}`;
                
                document.getElementById('modelSelectionArea').style.display = 'block';
                convertBtn.disabled = false;
                convertBtn.innerHTML = "‚ú® <b>Trasforma Ricetta</b>";
                convertBtn.style.background = "#2e7d32"; 

            } catch (e) {
                statusBox.className = 'status-box status-error';
                statusBox.innerText = "‚ùå Errore: " + e.message;
            }
        }

        async function processRecipe() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const text = document.getElementById('recipeInput').value;
            const modelName = document.getElementById('modelSelect').value; 
            const cardDiv = document.getElementById('recipeCard');
            const stepsDiv = document.getElementById('stepsContainer');
            const printBtn = document.getElementById('printBtn');

            if(!text) return alert("Inserisci il testo della ricetta!");

            stepsDiv.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">‚è≥ <b>Analisi in corso...</b><br>Sto convertendo le dosi e calcolando i tempi TM6.</div>';
            cardDiv.style.display = 'block';
            printBtn.style.display = 'none';
            cardDiv.scrollIntoView({ behavior: 'smooth' });

            const PROMPT = `
            Agisci come un Bimby TM6 (Thermomix) Chef esperto.
            Analizza il testo della ricetta fornita.
            
            OBIETTIVI:
            1. Titolo: Estrai il nome della ricetta.
            2. Porzioni: Estrai o stima per quante persone √® (es. "4 persone").
            3. Procedimento: Dividi in passaggi logici.
               - IMPORTANTE: Inserisci SEMPRE le quantit√† degli ingredienti nel testo del passaggio (es. "Mettere nel boccale 50g di olio").
            
            PARAMETRI TECNICI TM6 (Compila il campo 'tm6'):
            - Trito verdure: 5 sec / Vel 5.
            - Trito duro (Parmigiano/Cioccolato): 10 sec / Vel 8-10.
            - Soffritto: 3 min / 120¬∞C / Vel 1.
            - Cottura (Risotti/Sughi): 100¬∞C / Antiorario / Vel Soft (Cucchiaio).
            - Vapore: Temp Varoma / Vel 1.
            - Impasti: Modalit√† Spiga.
            - Montare: Farfalla / Vel 3.5.
            
            OUTPUT JSON:
            {
                "title": "...",
                "servings": "...",
                "steps": [
                    { "action": "Titolo breve", "desc": "Istruzione dettagliata con dosi...", "tm6": "Parametri tecnici" }
                ]
            }
            `;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: PROMPT + "\n\nRICETTA:\n" + text }] }]
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);

                let raw = data.candidates[0].content.parts[0].text;
                raw = raw.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const recipeData = JSON.parse(raw);
                
                document.getElementById('resTitle').innerText = recipeData.title || "Ricetta Bimby";
                document.getElementById('resServings').innerText = recipeData.servings || "Dosi standard";

                stepsDiv.innerHTML = "";
                recipeData.steps.forEach((step, i) => {
                    stepsDiv.innerHTML += `
                        <div class="step">
                            <span class="step-num">PASSO ${i+1} - ${step.action.toUpperCase()}</span>
                            <div class="step-desc">${step.desc}</div>
                            <div class="tm6-tag">‚öôÔ∏è ${step.tm6}</div>
                        </div>
                    `;
                });

                printBtn.style.display = 'block';

            } catch (e) {
                stepsDiv.innerHTML = `<div class="status-box status-error">Errore durante l'elaborazione: ${e.message}</div>`;
            }
        }
    </script>
</body>
</html>
